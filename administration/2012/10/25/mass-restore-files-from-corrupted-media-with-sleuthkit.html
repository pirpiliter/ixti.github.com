<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Mass-restore files from corrupted media with sleuthkit * ixti's personal scratchpad</title>
    <meta name="description" content="Personal blog of Aleksey V Zapparov AKA ixti">
    <meta name="viewport" content="width=device-width">
    <meta name="generator" content="jekyll">
    <link rel="stylesheet" type="text/css" href="/assets/app-c154aec9e7bb397b6af4159d0e0ef1a6.css">
  </head>
  <body>
    <header id="header">
      <h1><a href="/"><span>personal scratchpad</span></a></h1>
      <div id="top-navigation" class="navbar">
        <ul>
          <li><a href="https://github.com/ixti/ixti.github.com">Sources</a></li>
        </ul>
        <ul>
          <li><a href="https://github.com/ixti">GitHub</a></li>
          <li><a href="http://es.linkedin.com/in/zapparov">LinkedIn</a></li>
          <li><a href="https://twitter.com/zapparov">Twitter</a></li>
          <li><a href="http://feeds.feedburner.com/ixti">RSS</a></li>
        </ul>
      </div>
    </header>

    <article class="post">
  <header>
    <h2>Mass-restore files from corrupted media with sleuthkit</h2>
    
    <dl class="post-info">
  <dt>Date:</dt>
  <dd>25 Oct 2012</dd>

  
    <dt>Category:</dt>
    <dd><a href="/categories/administration.html">administration</a></dd>
  

  
    <dt>Tagged with:</dt>
    <dd><a href="/tags/hdd.html">hdd</a>, <a href="/tags/files.html">files</a>, <a href="/tags/recovery.html">recovery</a>, <a href="/tags/sleuthkit.html">sleuthkit</a>, and <a href="/tags/dd.html">dd</a></dd>
  
</dl>

  </header>

  <p>Not so long ago, I mentioned that one of my external hard drives become little
bit too slow, and was not able to remove some files, and system was always
proposing me to run file system check. But I was always in hurry, until one day,
when I decided to move files to another drive. Unfortunately, by some reason, I
decided to run <code>fsck</code> before copying file on another drive. When I came in the
morning my drive was not working properly anymore&hellip;</p>

<p>So, I lost all my <del>porn</del> photos. It was impossible to mount it, and the syslog
was full of messages like <code>Buffer I/O error on device sdb</code>. Googling left me
with sad feeling that I will never get my data recovered. But I was wrong and
thanks to all developers of <code>safecopy</code>, <code>testdisk</code>, <code>sleuthkit</code> and <code>autopsy</code>.</p>

<h5>Grabbing image of a failing drive</h5>

<p>As you might already guessed, <code>dd</code> was useless for me. So here&#39;s where
might <code>safecopy</code> comes for the rescue :)) This brilliant application helped
me to get as much data from drive as possible without any extra work:</p>
<div class="highlight"><pre><code class="text">$ cd /media/storage/recover-my-broken-drive
$ safecopy --stage1 /dev/sdb sdb-data

...

$ safecopy --stage2 /dev/sdb sdb-data

...

$ safecopy --stage3 /dev/sdb sdb-data
</code></pre></div>
<p>Use <code>man safecopy</code> for details. :))</p>

<h5>Bringing data back alive</h5>

<p>So the next day I was able to run <code>testdisk</code> on the result image file. And it
was able to determine my filesystem. Even more, I was able to mount this image,
but it was working really buggy. So I have investigated that image with
<code>autopsy</code>. I needed all files under one particular directory and all it&#39;s
sub-directories. Unfortunately autopsy does not gives you an option to recover
&ldquo;all files from that directory&rdquo;. But it gives you an <em>inode</em> of each file and
directory. That was what I was looking for. Now, knowing the inode of my
diretory I was able to get the list of all nested entries (files, dirs, etc):</p>
<div class="highlight"><pre><code class="text">$ fls -f ext2 -p -r ./sdb-data 8650754

r/r 8651063:    INCITS+ISO+IEC+14882-2003.pdf
...
</code></pre></div>
<p>You can read details on the output format on a <a href="fls-wiki">fls wiki page</a>. But in
short I needed all dirs/files that are not deleted, so the final command was:</p>
<div class="highlight"><pre><code class="text">$ fls -f ext2 -p -r ./sdb-data 8650754 \
  | grep -v &#39;^..-&#39; | grep -v &#39;^... \*&#39; &gt; files.lst
</code></pre></div>
<p>Now I had a &ldquo;clean&rdquo; list of files and directories I need to restore. To restore
a directory, all we have to do is to, surprise-surprise, <code>mkdir</code> it ;)) but to
recover a file, we need to output it&#39;s content. To get contents of a file from
the image byt it&#39;s inode, I used another tool from the sleuthkit box: <code>icat</code>.
Grabbing each file manually is dead-boring task, so here&#39;s a small <em>BASH</em> script
that did all the dirty work for me:</p>
<div class="highlight"><pre><code class="bash"><span class="nv">IMAGE</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">LIST</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">DEST</span><span class="o">=</span><span class="nv">$3</span>

cat <span class="nv">$LIST</span> | <span class="k">while </span><span class="nb">read </span>line; <span class="k">do</span>
<span class="k">   </span><span class="nv">filetype</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;$line&quot;</span> | awk <span class="o">{</span><span class="s1">&#39;print $1&#39;</span><span class="o">}</span><span class="sb">`</span>
   <span class="nv">filenode</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;$line&quot;</span> | awk <span class="o">{</span><span class="s1">&#39;print $2&#39;</span><span class="o">}</span><span class="sb">`</span>
   <span class="nv">filenode</span><span class="o">=</span><span class="k">${</span><span class="nv">filenode</span><span class="p">%:</span><span class="k">}</span>
   <span class="nv">filename</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;$line&quot;</span> | cut -f 2 -d <span class="s1">&#39;   &#39;</span><span class="sb">`</span>

   <span class="k">if</span> <span class="o">[</span> <span class="nv">$filetype</span> <span class="o">==</span> <span class="s2">&quot;r/r&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;$filename&quot;</span>
      mkdir -p <span class="s2">&quot;`dirname &quot;</span><span class="nv">$DEST</span>/<span class="nv">$filename</span><span class="s2">&quot;`&quot;</span>
      icat -f ext2 -r -s <span class="nv">$IMAGE</span> <span class="s2">&quot;$filenode&quot;</span> &gt; <span class="s2">&quot;$DEST/$filename&quot;</span>
   <span class="k">fi</span>
<span class="k">done</span>
</code></pre></div>
<p>And again, <code>man icat</code> for details ;))</p>

<h5>That&#39;s all!</h5>

<p>Hope this will help somebody. And I hope I will never need it by myself. ;))</p>

</article>



<!-- DISQUS -->
<div id="disqus_thread"></div>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


    <ul id="bottom-navigation" class="navbar">
      
        <li><a href="/archives/2012.html">2012</a></li>
      
        <li><a href="/archives/2011.html">2011</a></li>
      
        <li><a href="/archives/2010.html">2010</a></li>
      
    </ul>

    <footer id="footer" role="contentinfo">
      kindly generated by <a href="https://github.com/mojombo/jekyll">Jekyll</a>
      ~
      crafted by <a href="http://ixti.net">ixti</a>
      using <a href="http://gimp.org/">Gimp</a>
      and <a href="http://www.vim.org/">Vim</a>
      ~
      copyright &copy; 2010 Aleksey V Zapparov AKA ixti
    </footer>

    <script type="text/javascript" src="/assets/app-6136a26d0eb3d21f7cc38a822c932959.js"></script>
  </body>
</html>
