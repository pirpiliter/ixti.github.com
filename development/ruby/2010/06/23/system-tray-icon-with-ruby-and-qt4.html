<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>System tray icon with Ruby and QT4 * ixti's personal scratchpad</title>
    <meta name="description" content="Personal blog of Aleksey V Zapparov AKA ixti">
    <meta name="viewport" content="width=device-width">
    <meta name="generator" content="jekyll">
    <link rel="stylesheet" type="text/css" href="/assets/app-c154aec9e7bb397b6af4159d0e0ef1a6.css">
  </head>
  <body>
    <header id="header">
      <h1><a href="/"><span>personal scratchpad</span></a></h1>
      <div id="top-navigation" class="navbar">
        <ul>
          <li><a href="https://github.com/ixti/ixti.github.com">Sources</a></li>
        </ul>
        <ul>
          <li><a href="https://github.com/ixti">GitHub</a></li>
          <li><a href="http://es.linkedin.com/in/zapparov">LinkedIn</a></li>
          <li><a href="https://twitter.com/zapparov">Twitter</a></li>
          <li><a href="http://feeds.feedburner.com/ixti">RSS</a></li>
        </ul>
      </div>
    </header>

    <article class="post">
  <header>
    <h2>System tray icon with Ruby and QT4</h2>
    
    <dl class="post-info">
  <dt>Date:</dt>
  <dd>23 Jun 2010</dd>

  
    <dt>Category:</dt>
    <dd><a href="/categories/development/ruby.html">development/ruby</a></dd>
  

  
    <dt>Tagged with:</dt>
    <dd><a href="/tags/qt.html">qt</a>, <a href="/tags/ruby.html">ruby</a>, and <a href="/tags/system-tray.html">system-tray</a></dd>
  
</dl>

  </header>

  <p>In my previous post I have showed how to create a simple system tray icon in
ruby and GTK. Today, I will create exactly the same application but with QT4
instead of GTK&hellip; Before I started this, I was full of optimism that it will
be even easier to do this with QT. I was wrong :)) Because of some differences
it was not as easy as I wish it to be&hellip;</p>

<p>I was going to start with similar simple and really dumb example. But some
restrictions of QT disallowed me. So, to show a system tray icon, you need to
call <code>show</code> instance method. But before this, you must set <code>icon</code> instance
property, else it will throw a corresponding exception. So here&#39;s most simple
variant:</p>
<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;Qt4&#39;</span>
<span class="n">app</span> <span class="o">=</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:Application</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGV</span><span class="p">)</span>
<span class="n">si</span>  <span class="o">=</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:SystemTrayIcon</span><span class="o">.</span><span class="n">new</span>

<span class="n">si</span><span class="o">.</span><span class="n">icon</span> <span class="o">=</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:Icon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;/path/to/some/image.png&#39;</span><span class="p">)</span>
<span class="n">si</span><span class="o">.</span><span class="n">show</span>

<span class="n">app</span><span class="o">.</span><span class="n">exec</span>
</code></pre></div>
<p>There&#39;s no stock images like in GTK, at least I didn&#39;t found them, if you know -
let me know. According to QT&#39;s SDK there&#39;s <code>QIcon::fromTheme()</code> static method,
but unfortunately there&#39;s no corresponding one in qt4ruby. So we can skip step
with different types of icon image settings and go next. All snippets below will
assume that there are <code>app</code> and <code>si</code> initializations before, and <code>app.exec</code> call
after them. Now let&#39;s make our icon start|stop blinking on left click.</p>

<p>In QT all clicks (left, middle, right, etc) are handled by one signal -
<code>activated(QSystemTrayIcon::ActivationReason)</code>. Not the easiest name of the
signal to remember ;)) I spent about two hours trying to understand why SDK
says that <code>QStatusIcon</code> has <code>activated()</code> signal, but my app tells me that
there&#39;s no such signal. Anyway, finally I got it. Here&#39;s sample <code>activated()</code>
signal handler:</p>
<div class="highlight"><pre><code class="ruby"><span class="n">si</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="no">SIGNAL</span><span class="p">(</span><span class="s1">&#39;activated(QSystemTrayIcon::ActivationReason)&#39;</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">reason</span><span class="o">|</span>
  <span class="k">case</span> <span class="n">reason</span>
    <span class="k">when</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:SystemTrayIcon</span><span class="o">::</span><span class="ss">Trigger</span><span class="p">:</span>       <span class="nb">puts</span> <span class="s1">&#39;Left Click&#39;</span>
    <span class="k">when</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:SystemTrayIcon</span><span class="o">::</span><span class="ss">MiddleClick</span><span class="p">:</span>   <span class="nb">puts</span> <span class="s1">&#39;Middle Click&#39;</span>
    <span class="k">when</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:SystemTrayIcon</span><span class="o">::</span><span class="ss">Context</span><span class="p">:</span>       <span class="nb">puts</span> <span class="s1">&#39;Right Click&#39;</span>
    <span class="k">when</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:SystemTrayIcon</span><span class="o">::</span><span class="ss">DoubleClick</span><span class="p">:</span>   <span class="nb">puts</span> <span class="s1">&#39;Double Click&#39;</span>
    <span class="k">else</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>There&#39;s also <code>Qt::SystemTrayIcon::Unknown</code> reason but this is not very useful
IMHO. After we figured out how and where we need to handle left click, let&#39;s
make icon blinking. You probably will be surprised, but it&#39;s not trivial as
with GTK. <code>Qt::SystemTrayIcon</code> don&#39;t have neither <code>blinking</code> instance property,
nor any single method to make it blink. So to make icon blink we need to create
a timer which will be replacing icon with empty one and restore original back
again every 0.5 second:</p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># define standard icon, alternative (blank) one and current state handler</span>
<span class="n">std_icon</span> <span class="o">=</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:Icon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;/path/to/some/image.png&#39;</span><span class="p">)</span>
<span class="n">alt_icon</span> <span class="o">=</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:Icon</span><span class="o">.</span><span class="n">new</span>
<span class="n">blinking</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># assign default icon</span>
<span class="n">si</span><span class="o">.</span><span class="n">icon</span>  <span class="o">=</span> <span class="n">std_icon</span>
<span class="n">si</span><span class="o">.</span><span class="n">show</span>

<span class="c1"># run timer to swap icons every 0.5 second if blinking is true</span>
<span class="ss">Qt</span><span class="p">:</span><span class="ss">:Timer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">app</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">timer</span><span class="o">|</span>
  <span class="n">timer</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="no">SIGNAL</span><span class="p">(</span><span class="s1">&#39;timeout()&#39;</span><span class="p">))</span> <span class="k">do</span>
    <span class="n">si</span><span class="o">.</span><span class="n">icon</span> <span class="o">=</span> <span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">icon</span><span class="o">.</span><span class="n">isNull</span> <span class="p">?</span> <span class="n">std_icon</span> <span class="p">:</span> <span class="n">alt_icon</span><span class="p">)</span> <span class="k">if</span> <span class="n">blinking</span>
  <span class="k">end</span>
  <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># finally assign left click handler</span>
<span class="n">si</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="no">SIGNAL</span><span class="p">(</span><span class="s1">&#39;activated(QSystemTrayIcon::ActivationReason)&#39;</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">reason</span><span class="o">|</span>
  <span class="k">if</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:SystemTrayIcon</span><span class="o">::</span><span class="no">Trigger</span> <span class="o">==</span> <span class="n">reason</span>
    <span class="n">blinking</span> <span class="o">=</span> <span class="o">!</span><span class="n">blinking</span>
    <span class="n">si</span><span class="o">.</span><span class="n">icon</span>  <span class="o">=</span> <span class="n">blinking</span> <span class="p">?</span> <span class="n">alt_icon</span> <span class="p">:</span> <span class="n">std_icon</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>OK. It was not as easy as with GTK, but still, it works :)) So now let&#39;s create
context menu with exit item. First of all we need to create a <code>Qt::Menu</code> and
populate it with <code>Qt::Action</code>s:</p>
<div class="highlight"><pre><code class="ruby"><span class="n">menu</span> <span class="o">=</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:Menu</span><span class="o">.</span><span class="n">new</span>
<span class="n">quit</span> <span class="o">=</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:Action</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;&amp;amp;Quit&#39;</span><span class="p">,</span> <span class="n">menu</span><span class="p">)</span>

<span class="n">quit</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="no">SIGNAL</span><span class="p">(</span><span class="ss">:triggered</span><span class="p">))</span> <span class="p">{</span> <span class="n">app</span><span class="o">.</span><span class="n">quit</span> <span class="p">}</span>
<span class="n">menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">quit</span><span class="p">)</span>
</code></pre></div>
<p>And now the most interesting part, as I told before QT&#39;s system tray icon
handles all clicks by one signal. But for context pop-up menu there&#39;s a special
instance property <code>contextMenu</code> exist. So to show a popup menu you need to
assign it with <code>menu</code> so it will be popped up on right click! But remember,
<code>activated(QSystemTrayIcon::ActivationReason)</code> will also be handled. So
following code will pop up a menu and will output <em>Right Click</em> to the console:</p>
<div class="highlight"><pre><code class="ruby"><span class="n">si</span><span class="o">.</span><span class="n">contextMenu</span> <span class="o">=</span> <span class="n">menu</span>

<span class="n">si</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="no">SIGNAL</span><span class="p">(</span><span class="s1">&#39;activated(QSystemTrayIcon::ActivationReason)&#39;</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">reason</span><span class="o">|</span>
  <span class="k">if</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:SystemTrayIcon</span><span class="o">::</span><span class="no">Contex</span> <span class="o">==</span> <span class="n">treason</span>
    <span class="nb">puts</span> <span class="s1">&#39;Right Click&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>And now altogether again:</p>
<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;Qt4&#39;</span>

<span class="n">app</span> <span class="o">=</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:Application</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGV</span><span class="p">)</span>
<span class="n">si</span>  <span class="o">=</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:SystemTrayIcon</span><span class="o">.</span><span class="n">new</span>

<span class="n">std_icon</span> <span class="o">=</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:Icon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;/path/to/some/image.png&#39;</span><span class="p">)</span>
<span class="n">alt_icon</span> <span class="o">=</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:Icon</span><span class="o">.</span><span class="n">new</span>
<span class="n">blinking</span> <span class="o">=</span> <span class="kp">false</span>

<span class="n">si</span><span class="o">.</span><span class="n">icon</span>  <span class="o">=</span> <span class="n">std_icon</span>
<span class="n">si</span><span class="o">.</span><span class="n">show</span>

<span class="ss">Qt</span><span class="p">:</span><span class="ss">:Timer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">app</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">timer</span><span class="o">|</span>
  <span class="n">timer</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="no">SIGNAL</span><span class="p">(</span><span class="s1">&#39;timeout()&#39;</span><span class="p">))</span> <span class="k">do</span>
    <span class="n">si</span><span class="o">.</span><span class="n">icon</span> <span class="o">=</span> <span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">icon</span><span class="o">.</span><span class="n">isNull</span> <span class="p">?</span> <span class="n">std_icon</span> <span class="p">:</span> <span class="n">alt_icon</span><span class="p">)</span> <span class="k">if</span> <span class="n">blinking</span>
  <span class="k">end</span>
  <span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">menu</span> <span class="o">=</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:Menu</span><span class="o">.</span><span class="n">new</span>
<span class="n">quit</span> <span class="o">=</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:Action</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;&amp;amp;Quit&#39;</span><span class="p">,</span> <span class="n">menu</span><span class="p">)</span>

<span class="n">quit</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="no">SIGNAL</span><span class="p">(</span><span class="ss">:triggered</span><span class="p">))</span> <span class="p">{</span> <span class="n">app</span><span class="o">.</span><span class="n">quit</span> <span class="p">}</span>
<span class="n">menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">quit</span><span class="p">)</span>

<span class="n">si</span><span class="o">.</span><span class="n">contextMenu</span> <span class="o">=</span> <span class="n">menu</span>

<span class="n">si</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="no">SIGNAL</span><span class="p">(</span><span class="s1">&#39;activated(QSystemTrayIcon::ActivationReason)&#39;</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">reason</span><span class="o">|</span>
  <span class="k">case</span> <span class="n">reason</span>
    <span class="k">when</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:SystemTrayIcon</span><span class="o">::</span><span class="no">Trigger</span>
      <span class="n">blinking</span> <span class="o">=</span> <span class="o">!</span><span class="n">blinking</span>
      <span class="n">si</span><span class="o">.</span><span class="n">icon</span>  <span class="o">=</span> <span class="n">blinking</span> <span class="p">?</span> <span class="n">alt_icon</span> <span class="p">:</span> <span class="n">std_icon</span>
    <span class="k">when</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:SystemTrayIcon</span><span class="o">::</span><span class="ss">MiddleClick</span><span class="p">:</span>   <span class="nb">puts</span> <span class="s1">&#39;Middle Click&#39;</span>
    <span class="k">when</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:SystemTrayIcon</span><span class="o">::</span><span class="ss">Context</span><span class="p">:</span>       <span class="nb">puts</span> <span class="s1">&#39;Right Click&#39;</span>
    <span class="k">when</span> <span class="ss">Qt</span><span class="p">:</span><span class="ss">:SystemTrayIcon</span><span class="o">::</span><span class="ss">DoubleClick</span><span class="p">:</span>   <span class="nb">puts</span> <span class="s1">&#39;Double Click&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">app</span><span class="o">.</span><span class="n">exec</span>
</code></pre></div>
<h3>Useful links:</h3>

<ul>
<li><a href="http://rubyforge.org/projects/korundum/">qt4ruby homepage</a></li>
<li><a href="http://techbase.kde.org/Development/Tutorials/Qt4_Ruby_Tutorial">Qt4 Ruby Tutorial</a></li>
<li><a href="http://stackoverflow.com/questions/313629/worker-threads-in-ruby">Qt::Timer example</a></li>
</ul>

</article>



<!-- DISQUS -->
<div id="disqus_thread"></div>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


    <ul id="bottom-navigation" class="navbar">
      
        <li><a href="/archives/2012.html">2012</a></li>
      
        <li><a href="/archives/2011.html">2011</a></li>
      
        <li><a href="/archives/2010.html">2010</a></li>
      
    </ul>

    <footer id="footer" role="contentinfo">
      kindly generated by <a href="https://github.com/mojombo/jekyll">Jekyll</a>
      ~
      crafted by <a href="http://ixti.net">ixti</a>
      using <a href="http://gimp.org/">Gimp</a>
      and <a href="http://www.vim.org/">Vim</a>
      ~
      copyright &copy; 2010 Aleksey V Zapparov AKA ixti
    </footer>

    <script type="text/javascript" src="/assets/app-6136a26d0eb3d21f7cc38a822c932959.js"></script>
  </body>
</html>
