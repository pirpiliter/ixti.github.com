<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Creating images with QR code in Ruby * ixti's personal scratchpad</title>
    <meta name="description" content="Personal blog of Aleksey V Zapparov AKA ixti">
    <meta name="viewport" content="width=device-width">
    <meta name="generator" content="jekyll">
    <link rel="stylesheet" type="text/css" href="/assets/app-c154aec9e7bb397b6af4159d0e0ef1a6.css">
  </head>
  <body>
    <header id="header">
      <h1><a href="/"><span>personal scratchpad</span></a></h1>
      <div id="top-navigation" class="navbar">
        <ul>
          <li><a href="https://github.com/ixti/ixti.github.com">Sources</a></li>
        </ul>
        <ul>
          <li><a href="https://github.com/ixti">GitHub</a></li>
          <li><a href="http://es.linkedin.com/in/zapparov">LinkedIn</a></li>
          <li><a href="https://twitter.com/zapparov">Twitter</a></li>
          <li><a href="http://feeds.feedburner.com/ixti">RSS</a></li>
        </ul>
      </div>
    </header>

    <article class="post">
  <header>
    <h2>Creating images with QR code in Ruby</h2>
    
    <dl class="post-info">
  <dt>Date:</dt>
  <dd>27 Aug 2011</dd>

  
    <dt>Category:</dt>
    <dd><a href="/categories/development/ruby.html">development/ruby</a></dd>
  

  
    <dt>Tagged with:</dt>
    <dd><a href="/tags/ruby.html">ruby</a>, <a href="/tags/qr.html">qr</a>, <a href="/tags/code.html">code</a>, and <a href="/tags/rmagick.html">rmagick</a></dd>
  
</dl>

  </header>

  <p>Don&#39;t know why but recently I have decided that I want to have a <a href="http://en.wikipedia.org/wiki/QR_code">QR code</a>
with URL on each page of my blog that will be visible on printer-only variant of
blog. Unfortunately after I have prepared a proof of concept version, I realized
that in fact I don&#39;t need it, and most likely nobody will need it, at least on
my blog. But just for historic reasons I want to share my experience. I hope it
will be helpful for at least somebody.</p>

<p>For those of you who don&#39;t know what is QR code, here&#39;s what <a href="http://www.wikipedia.org/">Wikipedia</a>
says:</p>

<blockquote>
<p>A QR code (abbreviated from Quick Response code) is a type of matrix barcode
(or two-dimensional code) designed to be read by smartphones. The code
consists of black modules arranged in a square pattern on a white background.
The information encoded may be text, a URL, or other data.</p>
</blockquote>

<p>First of all, in order to build a QR code you will need <a href="http://whomwah.github.com/rqrcode/">rQRCode</a> gem:</p>
<div class="highlight"><pre><code class="bash">gem install rqrcode
</code></pre></div>
<p>You can see example of usage right on rQRCode&#39;s homepage, so there&#39;s no need for
copy-pasting demos. So we&#39;ll begin with more complex examples&hellip; But before we
start let&#39;s get some basic ideas about QR code:</p>

<ul>
<li>It&#39;s a matrix of true/false dots</li>
<li>It has equal width and height</li>
</ul>

<h3>QR code with HTML5 canvas</h3>

<p>I know that there is a native JavaScript version of QR code generator (in fact
rQRCode is a port of that library) but it seems like it&#39;s outdated. To be honest
this example was posted here just for fun - I always wanted to play with canvas
element but didn&#39;t had anything interesting to do. Now I found at least something
more or less interesting ;))</p>

<p>Let&#39;s assume, that we have a canvas element with id <code>qr</code> and text content that
was produced by rQRCode, something like this:</p>
<div class="highlight"><pre><code class="ruby"><span class="nb">puts</span> <span class="ss">RQRCode</span><span class="p">:</span><span class="ss">:QRCode</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;http://www.example.com/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="ss">:true</span> <span class="o">=&gt;</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Now, to convert that string, we can use this simple JavaScript, that will
replace <code>#</code> chars with black dots and <code></code> (spaces) with white dots:</p>
<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">scale</span>   <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>                              <span class="c1">// each dot&#39;s size in pixels</span>
    <span class="nx">dark</span>    <span class="o">=</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span>                            <span class="c1">// char representing &quot;dark&quot; dot</span>
    <span class="nx">qr</span>      <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;qr&#39;</span><span class="p">),</span>  <span class="c1">// canvas element</span>
    <span class="nx">data</span>    <span class="o">=</span> <span class="nx">qr</span><span class="p">.</span><span class="nx">textContent</span><span class="p">,</span>                 <span class="c1">// QR code as a string</span>
    <span class="nx">context</span> <span class="o">=</span> <span class="nx">qr</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>            <span class="c1">// context used to draw dots</span>

<span class="c1">// jQuery alike array iterator</span>
<span class="kd">var</span> <span class="nx">each</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">each</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fn</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// set canvas dimensions. amount of line breaks + 1 dot (last line has no NL)</span>
<span class="nx">qr</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">qr</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">scale</span> <span class="o">*</span> <span class="nx">data</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\n/g</span><span class="p">).</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">scale</span><span class="p">;</span>

<span class="c1">// for each row</span>
<span class="nx">each</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">y</span> <span class="o">*=</span> <span class="nx">scale</span><span class="p">;</span>

  <span class="c1">// for each col</span>
  <span class="nx">each</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/./g</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">col</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">x</span> <span class="o">*=</span> <span class="nx">scale</span><span class="p">;</span>

    <span class="nx">context</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="p">(</span><span class="nx">dark</span> <span class="o">===</span> <span class="nx">col</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;#000&#39;</span> <span class="o">:</span> <span class="s1">&#39;#fff&#39;</span><span class="p">;</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">scale</span><span class="p">,</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">scale</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>That&#39;s so simple! In fact I was even disappointed - it was not as fun as I was
expecting it to be ;)) But at least it works. You can try it easily, by
downloading <em>sample-1.html</em> from <em>support bits</em> of this article (see sources of
my <a href="https://github.com/ixti/blog">blog on GitHub</a>).</p>

<h3>Let&#39;s bring some Magick&hellip;</h3>

<p>To be honest preparing QR code with Rmagick is also not a big issue. The biggest
issue is to install <a href="https://github.com/rmagick/rmagick">RMagick</a> gem ;)) But installation of rmagick is out of
scope of this post. For me it was as simple with Ruby 1.9.2 as:</p>
<div class="highlight"><pre><code class="bash">gem install rmagick
</code></pre></div>
<p>Now, let&#39;s get to the most interesting part&hellip; To grab <em>dots</em> of our QR code we
will use <code>modules</code> attribute of <code>rQRCode</code> instance and it&#39;s method <code>dark?</code>.</p>

<p>First of all in order to save some time and lots of nerves, we need to
understand that <code>modules</code> is a matrix represented by 2-dimension array where
first dimension is a row, second - column, and <code>dark?(row, col)</code> returns
whenever given column in a row should be dark or not.</p>
<div class="highlight"><pre><code class="ruby"><span class="n">qr</span><span class="o">.</span><span class="n">modules</span><span class="o">[</span><span class="mi">1</span><span class="o">][</span><span class="mi">2</span><span class="o">]</span> <span class="sr">//</span> <span class="o">-&gt;</span> <span class="n">second</span> <span class="n">row</span><span class="p">,</span> <span class="n">third</span> <span class="n">column</span>
<span class="n">qr</span><span class="o">.</span><span class="n">dark?</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   <span class="sr">//</span> <span class="o">-&gt;</span> <span class="n">whenever</span> <span class="n">second</span> <span class="n">row</span><span class="p">,</span> <span class="n">third</span> <span class="n">column</span> <span class="n">should</span> <span class="n">be</span> <span class="n">dark</span> <span class="ow">or</span> <span class="ow">not</span>
</code></pre></div>
<p>After you got the idea about <em>internal secrets</em>, you can easily create your own
QR code image generator, like this:</p>
<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;rqrcode&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;RMagick&#39;</span>

<span class="c1"># usage: ruby sample-2.rb &quot;http://www.example.com&quot; /tmp/demo.png</span>

<span class="no">INPUT</span>   <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
<span class="no">OUTPUT</span>  <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
<span class="no">SCALE</span>   <span class="o">=</span> <span class="mi">4</span>


<span class="c1"># prepare qr and img objects</span>
<span class="n">qr</span>    <span class="o">=</span> <span class="ss">RQRCode</span><span class="p">:</span><span class="ss">:QRCode</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">INPUT</span><span class="p">)</span>
<span class="n">size</span>  <span class="o">=</span> <span class="n">qr</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">count</span> <span class="o">*</span> <span class="no">SCALE</span>
<span class="n">img</span>   <span class="o">=</span> <span class="ss">Magick</span><span class="p">:</span><span class="ss">:Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>


<span class="c1"># draw matrix</span>
<span class="n">qr</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">each_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
  <span class="n">row</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="no">SCALE</span>

  <span class="n">qr</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">each_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="no">SCALE</span>
    <span class="n">dot</span> <span class="o">=</span> <span class="ss">Magick</span><span class="p">:</span><span class="ss">:Draw</span><span class="o">.</span><span class="n">new</span>

    <span class="n">dot</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">qr</span><span class="o">.</span><span class="n">dark?</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="p">?</span> <span class="s1">&#39;black&#39;</span> <span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">dot</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="no">SCALE</span><span class="p">,</span> <span class="n">row</span> <span class="o">+</span> <span class="no">SCALE</span><span class="p">)</span>
    <span class="n">dot</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="c1"># produce image</span>
<span class="n">img</span><span class="o">.</span><span class="n">write</span> <span class="no">OUTPUT</span>
</code></pre></div>
<h3>Going wild</h3>

<p>Although examples above are clean enough, real life usage is much more
interesting than an abstract horse in surrealistic vacuum. ;)) That&#39;s why I have
added QR Code into the bottom of each page (visible on &ldquo;printer-friendly&rdquo;
version of styles). Explanation of how did I made this is big enough to become
separate article. So, you can either wait for my new post or take a look at
sources (see revision <a href="https://github.com/ixti/blog/tree/cf2c8c71c5440cebfe1b601f4449ae6a711b9002">cf2c8c71c5440cebfe1b601f4449ae6a711b9002</a>) of my blog
for interesting files:</p>

<ul>
<li>config.ru</li>
<li>templates/layout.rhtml</li>
<li>public/js/application.js</li>
</ul>

<h3>Legal Note</h3>

<p>&ldquo;QR Code&rdquo; is registered trademark of <a href="http://www.denso-wave.com/en/adcd/">DENSO WAVE</a> INCORPORATED.</p>

<p>This registered trademark applies only for the word &ldquo;QR Code&rdquo;, and not for the
QR Code pattern (image). See <a href="http://www.denso-wave.com/qrcode/faqpatent-e.html">QR Code Patent FAQ</a> for more info.</p>

</article>


  <section class="downloads">
    <h2>Downloadable bits</h2>
    <ul>
      
        <a href="/downloads/2011-08-27-creating-images-with-qr-code-in-ruby.zip">2011-08-27-creating-images-with-qr-code-in-ruby.zip</a>
      
    </ul>
  </section>


<!-- DISQUS -->
<div id="disqus_thread"></div>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


    <ul id="bottom-navigation" class="navbar">
      
        <li><a href="/archives/2012.html">2012</a></li>
      
        <li><a href="/archives/2011.html">2011</a></li>
      
        <li><a href="/archives/2010.html">2010</a></li>
      
    </ul>

    <footer id="footer" role="contentinfo">
      kindly generated by <a href="https://github.com/mojombo/jekyll">Jekyll</a>
      ~
      crafted by <a href="http://ixti.net">ixti</a>
      using <a href="http://gimp.org/">Gimp</a>
      and <a href="http://www.vim.org/">Vim</a>
      ~
      copyright &copy; 2010 Aleksey V Zapparov AKA ixti
    </footer>

    <script type="text/javascript" src="/assets/app-6136a26d0eb3d21f7cc38a822c932959.js"></script>
  </body>
</html>
