<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Don't fool yourself async-calling things with sync nature in Node.JS * ixti's personal scratchpad</title>
    <meta name="description" content="Personal blog of Aleksey V Zapparov AKA ixti">
    <meta name="viewport" content="width=device-width">
    <meta name="generator" content="jekyll">
    <link rel="stylesheet" type="text/css" href="/assets/app-c154aec9e7bb397b6af4159d0e0ef1a6.css">
  </head>
  <body>
    <header id="header">
      <h1><a href="/"><span>personal scratchpad</span></a></h1>
      <div id="top-navigation" class="navbar">
        <ul>
          <li><a href="https://github.com/ixti/ixti.github.com">Sources</a></li>
        </ul>
        <ul>
          <li><a href="https://github.com/ixti">GitHub</a></li>
          <li><a href="http://es.linkedin.com/in/zapparov">LinkedIn</a></li>
          <li><a href="https://twitter.com/zapparov">Twitter</a></li>
          <li><a href="http://feeds.feedburner.com/ixti">RSS</a></li>
        </ul>
      </div>
    </header>

    <article class="post">
  <header>
    <h2>Don't fool yourself async-calling things with sync nature in Node.JS</h2>
    
    <dl class="post-info">
  <dt>Date:</dt>
  <dd>30 Jul 2011</dd>

  
    <dt>Category:</dt>
    <dd><a href="/categories/development/node.js.html">development/node.js</a></dd>
  

  
    <dt>Tagged with:</dt>
    <dd><a href="/tags/callback.html">callback</a>, <a href="/tags/asynchronous.html">asynchronous</a>, <a href="/tags/syscall.html">syscall</a>, and <a href="/tags/javascript.html">javascript</a></dd>
  
</dl>

  </header>

  <p>I bet almost everybody knows about <a href="http://nodejs.org/">Node.JS</a> these days. By today it&#39;s the most
popular implementation of <a href="http://www.commonjs.org/">CommonJS</a>. Because of &ldquo;asynchronous event-driven
model&rdquo; some developers force callback based usage even with absolutely trivial
and/or synchronous things. So basically this post is just to prove some obvious
points for myself.</p>

<blockquote>
<p>You must unlearn what you have learned.</p>

<p><em>Master Yoda</em></p>
</blockquote>

<p>OK. I&#39;m not against callback based functions. I&#39;m not against asynchronous model
at all. But any particular thing in this world is synchronous by it&#39;s nature.
And there&#39;s no need to make simple things complicated. Don&#39;t forget to keep it
simple stupid!</p>

<p>Instead some of Node.JS adepts actually believes, that everything in this world
should return values via callback with <code>err</code> as first argument. Still wonders
how these people didn&#39;t forced proposing of replacing <code>*</code> operator with
&ldquo;asynchronous&rdquo; version, e.g.:</p>
<div class="highlight"><pre><code class="javascript"><span class="nb">Math</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">});</span>
</code></pre></div>
<h3>Checking file existence synchronously</h3>

<p>Let&#39;s write a dummy test script that will run <code>path.existsSync</code> multiple times
and monitor how much time will it take to run it:</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// file: exists-test-1.js</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span>
    <span class="nx">file</span> <span class="o">=</span> <span class="s1">&#39;/tmp/abc&#39;</span><span class="p">,</span>
    <span class="nx">count</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
    <span class="nx">title</span> <span class="o">=</span> <span class="s1">&#39;Iterating &#39;</span> <span class="o">+</span> <span class="nx">count</span> <span class="o">+</span> <span class="s1">&#39; times&#39;</span><span class="p">;</span>

<span class="c1">// start timer</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">time</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>

<span class="k">while</span> <span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// we&#39;re done. show us results</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">timeEnd</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
</code></pre></div>
<p>Take a look what we have:</p>
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span><span class="k">for </span>i in <span class="o">{</span>1..3<span class="o">}</span>; <span class="k">do </span>node ./exists-test-1.js; <span class="k">done</span>
Iterating 100000 <span class="nb">times</span>: 3589ms
Iterating 100000 <span class="nb">times</span>: 3596ms
Iterating 100000 <span class="nb">times</span>: 3590ms
</code></pre></div>
<h3>Checking file existence asynchronously</h3>

<p>Now, let&#39;s replace <code>path.existsSync</code> with asynchronous <code>path.exists</code> and see
what will change:</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// file: exists-test-2.js</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span>
    <span class="nx">file</span> <span class="o">=</span> <span class="s1">&#39;/tmp/abc&#39;</span><span class="p">,</span>
    <span class="nx">count</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
    <span class="nx">title</span> <span class="o">=</span> <span class="s1">&#39;Iterating &#39;</span> <span class="o">+</span> <span class="nx">count</span> <span class="o">+</span> <span class="s1">&#39; times&#39;</span><span class="p">;</span>

<span class="c1">// start timer</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">time</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>

<span class="k">while</span> <span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">path</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(){</span>
    <span class="c1">// do nothing </span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// we&#39;re done. show us results</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">timeEnd</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
</code></pre></div>
<p>If you was out for a cup of coffee while running test, and if you are one of
those blind async fanboys you would probably scream <em>&ldquo;I told you!&rdquo;</em></p>
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span><span class="k">for </span>i in <span class="o">{</span>1..3<span class="o">}</span>; <span class="k">do </span>node ./exists-test-2.js; <span class="k">done</span>
Iterating 100000 <span class="nb">times</span>: 567ms
Iterating 100000 <span class="nb">times</span>: 578ms
Iterating 100000 <span class="nb">times</span>: 536ms
</code></pre></div>
<p>But if you was here while running test, you would mention that there were about
3-6 seconds of delay between test runs. And of course, if you understand it&#39;s
nature at least same primitive level as I do, you&#39;ll understand the cause.
The reasone is because, all <code>path.exists</code> were delayed and so <code>console.timeEnd</code>
was called before all <code>exists</code> were fired and handled.</p>

<h3>Checking file existence asynchronously (how much time will it take in fact?)</h3>

<p>Let&#39;s modify our last test in order to show us the same time as in synchronous
version test (from entry until every single call finished):</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">// file: exists-test-3.js</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span>
    <span class="nx">file</span> <span class="o">=</span> <span class="s1">&#39;/tmp/abc&#39;</span><span class="p">,</span>
    <span class="nx">count</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
    <span class="nx">title</span> <span class="o">=</span> <span class="s1">&#39;Iterating &#39;</span> <span class="o">+</span> <span class="nx">count</span> <span class="o">+</span> <span class="s1">&#39; times&#39;</span><span class="p">;</span>

<span class="c1">// start timer</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">time</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>

<span class="k">while</span> <span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">path</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(){</span>
    <span class="c1">// do nothing </span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// we&#39;re done. show us results</span>
<span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">timeEnd</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>Surprise for the fanboys, but not for the most of people how are able to think
for themselves. :)) Basically results are really easy to be expected:</p>
<div class="highlight"><pre><code class="bash"><span class="nv">$ </span><span class="k">for </span>i in <span class="o">{</span>1..3<span class="o">}</span>; <span class="k">do </span>node ./exists-test-3.js; <span class="k">done</span>
Iterating 100000 <span class="nb">times</span>: 8238ms
Iterating 100000 <span class="nb">times</span>: 8561ms
Iterating 100000 <span class="nb">times</span>: 8487ms
</code></pre></div>
<h3>P.S.</h3>

<p>You&#39;ll never jump above your head. Think of the processor as about a clerk doing
his paperwork. It can delay processing of some of the papers in order to accept
more incoming papers. But this won&#39;t make him work faster - will only move queue
of incoming papers from the persons awaiting to his desk, but even persons won&#39;t
get anyway, they will still be waiting.</p>

<p>Of course, clerk will be able to preprocess some of the papers and those who are
easier, process the same time it accepts papers, but this will delay queue
execution for more time, as first person will be forced to wait until his papers
will be processed while clerk will be serving one came after.</p>

<p>Yes, sometimes, probably, this behavior is what you really want. For example,
it&#39;s OK to asynchronously read/write some big amount of data, so you&#39;ll be able
to serve other clients with &ldquo;smaller&rdquo; needs, because in this case the one
requested &ldquo;long taking&rdquo; operation will not see big difference, just as you won&#39;t
mention 10 cents when you are talking about prices &gt;100 Euros. In opposite side
you will mention extra 10 cents if the cost was 15 cents only. So pay attention
on what are you doing, don&#39;t act as a monkey, repeating someones mantras,
especially when that person see nothing further than his nose.</p>

</article>



<!-- DISQUS -->
<div id="disqus_thread"></div>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


    <ul id="bottom-navigation" class="navbar">
      
        <li><a href="/archives/2012.html">2012</a></li>
      
        <li><a href="/archives/2011.html">2011</a></li>
      
        <li><a href="/archives/2010.html">2010</a></li>
      
    </ul>

    <footer id="footer" role="contentinfo">
      kindly generated by <a href="https://github.com/mojombo/jekyll">Jekyll</a>
      ~
      crafted by <a href="http://ixti.net">ixti</a>
      using <a href="http://gimp.org/">Gimp</a>
      and <a href="http://www.vim.org/">Vim</a>
      ~
      copyright &copy; 2010 Aleksey V Zapparov AKA ixti
    </footer>

    <script type="text/javascript" src="/assets/app-6136a26d0eb3d21f7cc38a822c932959.js"></script>
  </body>
</html>
